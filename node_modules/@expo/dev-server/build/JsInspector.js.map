{"version":3,"file":"JsInspector.js","names":["openingChildProcess","openJsInspector","app","devtoolsFrontendRev","urlBase","ws","webSocketDebuggerUrl","replace","url","encodeURIComponent","launchChromiumAsync","closeJsInspector","kill","queryInspectorAppAsync","metroServerOrigin","appId","apps","queryAllInspectorAppsAsync","find","description","resp","fetch","transformApps","json","filter","title","deviceIdToAppId","deviceId","id","split","map","tmpDir","require","tempProfileDir","path","join","launchArgs","supportedChromiums","open","chrome","edge","chromium","launchAppAsync","Error","appName","os","platform","Array","isArray","appDirectory","osascript","execAsync","appPath","globSync","cwd","trim","absolute","spawn","stdio","result","openApp","arguments","newInstance","wait","exitCode"],"sources":["../src/JsInspector.ts"],"sourcesContent":["import * as osascript from '@expo/osascript';\nimport { ChildProcess, spawn } from 'child_process';\nimport { sync as globSync } from 'glob';\nimport fetch from 'node-fetch';\nimport open from 'open';\nimport os from 'os';\nimport path from 'path';\n\nexport interface MetroInspectorProxyApp {\n  description: string;\n  devtoolsFrontendUrl: string;\n  faviconUrl: string;\n  id: string;\n  title: string;\n  type: 'node';\n  vm: 'Hermes' | \"don't use\";\n  webSocketDebuggerUrl: string;\n}\n\nlet openingChildProcess: ChildProcess | null = null;\n\nexport function openJsInspector(app: MetroInspectorProxyApp) {\n  // To update devtoolsFrontendRev, find the full commit hash in the url:\n  // https://chromium.googlesource.com/chromium/src.git/+log/refs/tags/{CHROME_VERSION}/chrome/VERSION\n  //\n  // 1. Replace {CHROME_VERSION} with the target chrome version\n  // 2. Click the first log item in the webpage\n  // 3. The full commit hash is the desired revision\n  const devtoolsFrontendRev = 'e3cd97fc771b893b7fd1879196d1215b622c2bed'; // Chrome 90.0.4430.212\n\n  const urlBase = `https://chrome-devtools-frontend.appspot.com/serve_rev/@${devtoolsFrontendRev}/inspector.html`;\n  const ws = app.webSocketDebuggerUrl.replace(/^ws:\\/\\//, '');\n  const url = `${urlBase}?panel=sources&v8only=true&ws=${encodeURIComponent(ws)}`;\n  launchChromiumAsync(url);\n}\n\nexport function closeJsInspector() {\n  if (openingChildProcess != null) {\n    openingChildProcess.kill();\n    openingChildProcess = null;\n  }\n}\n\nexport async function queryInspectorAppAsync(\n  metroServerOrigin: string,\n  appId: string\n): Promise<MetroInspectorProxyApp | null> {\n  const apps = await queryAllInspectorAppsAsync(metroServerOrigin);\n  return apps.find((app) => app.description === appId) ?? null;\n}\n\nexport async function queryAllInspectorAppsAsync(\n  metroServerOrigin: string\n): Promise<MetroInspectorProxyApp[]> {\n  const resp = await fetch(`${metroServerOrigin}/json/list`);\n  const apps: MetroInspectorProxyApp[] = transformApps(await resp.json());\n  // Only use targets with better reloading support\n  return apps.filter((app) => app.title === 'React Native Experimental (Improved Chrome Reloads)');\n}\n\n// The description of `React Native Experimental (Improved Chrome Reloads)` target is `don't use` from metro.\n// This function tries to transform the unmeaningful description to appId\nfunction transformApps(apps: MetroInspectorProxyApp[]): MetroInspectorProxyApp[] {\n  const deviceIdToAppId: Record<string, string> = {};\n\n  for (const app of apps) {\n    if (app.description !== \"don't use\") {\n      const deviceId = app.id.split('-')[0];\n      const appId = app.description;\n      deviceIdToAppId[deviceId] = appId;\n    }\n  }\n\n  return apps.map((app) => {\n    if (app.description === \"don't use\") {\n      const deviceId = app.id.split('-')[0];\n      app.description = deviceIdToAppId[deviceId] ?? app.description;\n    }\n    return app;\n  });\n}\n\nasync function launchChromiumAsync(url: string): Promise<void> {\n  // For dev-client connecting metro in LAN, the request to fetch sourcemaps may be blocked by Chromium\n  // with insecure-content (https page send xhr for http resource).\n  // Adding `--allow-running-insecure-content` to overcome this limitation\n  // without users manually allow insecure-content in site settings.\n  // However, if there is existing chromium browser process, the argument will not take effect.\n  // We also pass a `--user-data-dir=` as temporary profile and force chromium to create new browser process.\n  const tmpDir = require('temp-dir');\n  const tempProfileDir = path.join(tmpDir, 'expo-inspector');\n  const launchArgs = [\n    `--app=${url}`,\n    '--allow-running-insecure-content',\n    `--user-data-dir=${tempProfileDir}`,\n    '--no-first-run',\n    '--no-default-browser-check',\n  ];\n\n  const supportedChromiums = [open.apps.chrome, open.apps.edge];\n  for (const chromium of supportedChromiums) {\n    try {\n      await launchAppAsync(chromium, launchArgs);\n      return;\n    } catch {}\n  }\n\n  throw new Error(\n    'Unable to find a browser on the host to open the inspector. Supported browsers: Google Chrome, Microsoft Edge'\n  );\n}\n\nasync function launchAppAsync(\n  appName: string | readonly string[],\n  launchArgs: string[]\n): Promise<void> {\n  if (os.platform() === 'darwin' && !Array.isArray(appName)) {\n    const appDirectory = await osascript.execAsync(\n      `POSIX path of (path to application \"${appName}\")`\n    );\n    const appPath = globSync('Contents/MacOS/*', { cwd: appDirectory.trim(), absolute: true })?.[0];\n    if (!appPath) {\n      throw new Error(`Cannot find application path from ${appDirectory}Contents/MacOS`);\n    }\n    closeJsInspector();\n    openingChildProcess = spawn(appPath, launchArgs, { stdio: 'ignore' });\n    return;\n  }\n\n  const result = await open.openApp(appName, {\n    arguments: launchArgs,\n    newInstance: true,\n    wait: true,\n  });\n  if (result.exitCode !== 0) {\n    throw new Error(`Cannot find application: ${appName}`);\n  }\n}\n"],"mappings":"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"}