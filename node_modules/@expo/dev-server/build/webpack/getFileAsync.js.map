{"version":3,"file":"getFileAsync.js","names":["getFileFromCompilerAsync","compiler","fileName","platform","platformCompiler","getCompilerForPlatform","Promise","resolve","reject","outputFileSystem","readFile","error","content","toString","getPlatformFromRequest","request","headers","url","match","assert","compilers","find","options","name","createGetFileNameFromUrl","publicPath","filename","getFilenameFromUrl","Error"],"sources":["../../src/webpack/getFileAsync.ts"],"sourcesContent":["import assert from 'assert';\nimport type { IncomingMessage } from 'http';\nimport webpack from 'webpack';\n// @ts-ignore\nimport { getFilenameFromUrl } from 'webpack-dev-middleware/lib/util';\n\nexport type AnyCompiler = webpack.Compiler | webpack.MultiCompiler;\n\n/**\n * Read a file from the webpack \"compiler\".\n *\n * @param compiler webpack compiler\n * @param filename Like: `/Users/evanbacon/Documents/GitHub/lab/yolo47/web-build/index.bundle`\n * @returns\n */\nexport function getFileFromCompilerAsync(\n  compiler: AnyCompiler,\n  { fileName, platform }: { fileName: string; platform?: string }\n): Promise<string> {\n  const platformCompiler = getCompilerForPlatform(compiler, platform);\n  return new Promise<string>((resolve, reject) =>\n    (platformCompiler.outputFileSystem as any).readFile(\n      fileName,\n      (error: Error | undefined, content: string | Buffer) => {\n        if (error || !content) {\n          reject(error);\n        } else {\n          resolve(content.toString());\n        }\n      }\n    )\n  );\n}\n\nexport function getPlatformFromRequest(request: IncomingMessage): string | null {\n  // Use the expo updates spec to check the platform.\n  if (typeof request.headers['expo-platform'] === 'string') {\n    return request.headers['expo-platform'] ?? null;\n  }\n\n  // Get the platform from the query params cheaply.\n  return request?.url?.match?.(/[?|&]platform=(\\w+)[&|\\\\]/)?.[1] ?? null;\n}\n\n/**\n * Get the Webpack compiler for a given platform.\n * In Expo we distinguish platforms by using the `name` property of the Webpack config.\n *\n * When the platform is undefined, or the compiler cannot be identified, we assert.\n *\n * @param compiler\n * @param platform\n * @returns\n */\nexport function getCompilerForPlatform(compiler: AnyCompiler, platform?: string): webpack.Compiler {\n  if (!('compilers' in compiler)) {\n    return compiler;\n  }\n  assert(platform, 'platform must be provided for multi-compiler servers');\n  const platformCompiler = compiler.compilers.find(({ options }) => options.name === platform);\n  assert(platformCompiler, `Could not find Webpack compiler for platform: ${platform}`);\n  return platformCompiler;\n}\n\nexport function createGetFileNameFromUrl(compiler: AnyCompiler, publicPath: string = '/') {\n  return function ({ url, platform }: { url: string; platform?: string }): string {\n    const platformCompiler = getCompilerForPlatform(compiler, platform);\n\n    const filename = getFilenameFromUrl(\n      // public path\n      publicPath,\n      platformCompiler,\n      url\n    );\n    if (!filename) {\n      throw new Error(`Cannot get Webpack file name from url: ${url}`);\n    }\n    return filename;\n  };\n}\n"],"mappings":";;;;;;;;;;AAAA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;AAIA;EAAA;;EAAA;IAAA;EAAA;;EAAA;AAAA;;;;AADA;;AAKA;AACA;AACA;AACA;AACA;AACA;AACA;AACO,SAASA,wBAAT,CACLC,QADK,EAEL;EAAEC,QAAF;EAAYC;AAAZ,CAFK,EAGY;EACjB,MAAMC,gBAAgB,GAAGC,sBAAsB,CAACJ,QAAD,EAAWE,QAAX,CAA/C;EACA,OAAO,IAAIG,OAAJ,CAAoB,CAACC,OAAD,EAAUC,MAAV,KACxBJ,gBAAgB,CAACK,gBAAlB,CAA2CC,QAA3C,CACER,QADF,EAEE,CAACS,KAAD,EAA2BC,OAA3B,KAAwD;IACtD,IAAID,KAAK,IAAI,CAACC,OAAd,EAAuB;MACrBJ,MAAM,CAACG,KAAD,CAAN;IACD,CAFD,MAEO;MACLJ,OAAO,CAACK,OAAO,CAACC,QAAR,EAAD,CAAP;IACD;EACF,CARH,CADK,CAAP;AAYD;;AAEM,SAASC,sBAAT,CAAgCC,OAAhC,EAAyE;EAAA;;EAC9E;EACA,IAAI,OAAOA,OAAO,CAACC,OAAR,CAAgB,eAAhB,CAAP,KAA4C,QAAhD,EAA0D;IAAA;;IACxD,gCAAOD,OAAO,CAACC,OAAR,CAAgB,eAAhB,CAAP,yEAA2C,IAA3C;EACD,CAJ6E,CAM9E;;;EACA,8BAAOD,OAAP,aAAOA,OAAP,uCAAOA,OAAO,CAAEE,GAAhB,uEAAO,aAAcC,KAArB,gFAAO,sCAAsB,2BAAtB,CAAP,0DAAO,sBAAqD,CAArD,CAAP,qEAAkE,IAAlE;AACD;AAED;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACO,SAASb,sBAAT,CAAgCJ,QAAhC,EAAuDE,QAAvD,EAA4F;EACjG,IAAI,EAAE,eAAeF,QAAjB,CAAJ,EAAgC;IAC9B,OAAOA,QAAP;EACD;;EACD,IAAAkB,iBAAA,EAAOhB,QAAP,EAAiB,sDAAjB;EACA,MAAMC,gBAAgB,GAAGH,QAAQ,CAACmB,SAAT,CAAmBC,IAAnB,CAAwB,CAAC;IAAEC;EAAF,CAAD,KAAiBA,OAAO,CAACC,IAAR,KAAiBpB,QAA1D,CAAzB;EACA,IAAAgB,iBAAA,EAAOf,gBAAP,EAA0B,iDAAgDD,QAAS,EAAnF;EACA,OAAOC,gBAAP;AACD;;AAEM,SAASoB,wBAAT,CAAkCvB,QAAlC,EAAyDwB,UAAkB,GAAG,GAA9E,EAAmF;EACxF,OAAO,UAAU;IAAER,GAAF;IAAOd;EAAP,CAAV,EAAyE;IAC9E,MAAMC,gBAAgB,GAAGC,sBAAsB,CAACJ,QAAD,EAAWE,QAAX,CAA/C;IAEA,MAAMuB,QAAQ,GAAG,IAAAC,0BAAA,GACf;IACAF,UAFe,EAGfrB,gBAHe,EAIfa,GAJe,CAAjB;;IAMA,IAAI,CAACS,QAAL,EAAe;MACb,MAAM,IAAIE,KAAJ,CAAW,0CAAyCX,GAAI,EAAxD,CAAN;IACD;;IACD,OAAOS,QAAP;EACD,CAbD;AAcD"}